# è¯„ä¼°æœåŠ¡åå°è¿è¡ŒæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›å¤šç§æ–¹å¼è®©ç¿»è¯‘è¯„ä¼°æœåŠ¡åœ¨åå°è¿è¡Œï¼Œå³ä½¿æ–­å¼€è¿œç¨‹è¿æ¥ä¹Ÿä¸ä¼šåœæ­¢ã€‚

## ğŸ¯ æ¨èæ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **systemd** | âœ… è‡ªåŠ¨å¯åŠ¨<br>âœ… è‡ªåŠ¨é‡å¯<br>âœ… ç³»ç»Ÿçº§ç®¡ç† | âš ï¸ éœ€è¦rootæƒé™ | **ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰** |
| **nohup** | âœ… ç®€å•å¿«é€Ÿ<br>âœ… æ— éœ€root | âš ï¸ éœ€æ‰‹åŠ¨ç®¡ç†<br>âš ï¸ æ— è‡ªåŠ¨é‡å¯ | ä¸´æ—¶æµ‹è¯• |
| **screen/tmux** | âœ… å¯äº¤äº’<br>âœ… æ— éœ€root | âš ï¸ éœ€æ‰‹åŠ¨ç®¡ç† | å¼€å‘è°ƒè¯• |
| **supervisor** | âœ… åŠŸèƒ½å¼ºå¤§<br>âœ… æœ‰Webç•Œé¢ | âš ï¸ éœ€é¢å¤–å®‰è£… | ä¸­ç­‰è§„æ¨¡éƒ¨ç½² |

---

## ğŸš€ æ–¹æ¡ˆä¸€ï¼šsystemdæœåŠ¡ï¼ˆæ¨èï¼‰

### ä¼˜ç‚¹
- âœ… ç³»ç»Ÿçº§æœåŠ¡ç®¡ç†
- âœ… å¼€æœºè‡ªåŠ¨å¯åŠ¨
- âœ… å´©æºƒè‡ªåŠ¨é‡å¯
- âœ… æ—¥å¿—ç»Ÿä¸€ç®¡ç†
- âœ… èµ„æºé™åˆ¶é…ç½®

### åˆ›å»ºæœåŠ¡æ–‡ä»¶

æ ¹æ®ä½ çš„å®é™…è·¯å¾„ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š

```bash
# ç¼–è¾‘æœåŠ¡æ–‡ä»¶
sudo nano /etc/systemd/system/translation-evaluator.service
```

**æœåŠ¡æ–‡ä»¶å†…å®¹**ï¼ˆè¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹è·¯å¾„ï¼‰ï¼š

```ini
[Unit]
Description=Translation Evaluator API Service
After=network.target

[Service]
Type=simple
User=root
Group=root
WorkingDirectory=/root/bianjb/translation_evaluator

# ç¯å¢ƒå˜é‡ï¼ˆæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰
Environment="PATH=/root/miniconda3/envs/tranlator_eval/bin"
Environment="USE_REQUEST_QUEUE=true"
Environment="MAX_QUEUE_SIZE=50"
Environment="REQUEST_TIMEOUT=600"
Environment="USE_BLEURT=true"
Environment="BLEURT_USE_SUBPROCESS=true"
Environment="BLEURT_PYTHON_ENV=/root/miniconda3/envs/translator_eval_bleurt/bin/python"
Environment="BLEURT_WORKER_SCRIPT=/root/bianjb/translation_evaluator/bleurt_worker.py"
Environment="BLEURT_CHECKPOINT=/root/bianjb/translation_evaluator/BLEURT-20"
Environment="COMET_MODEL_PATH=/root/bianjb/wmt22-comet-da"
Environment="HF_HOME=/root/.cache/huggingface"

# å¯åŠ¨å‘½ä»¤ï¼ˆå•worker + é¢„åŠ è½½ï¼Œé€‚åˆé˜Ÿåˆ—æ¨¡å¼ï¼‰
ExecStart=/root/miniconda3/envs/tranlator_eval/bin/gunicorn \
    -w 1 \
    --preload \
    -b 0.0.0.0:5001 \
    --timeout 600 \
    --access-logfile /root/bianjb/translation_evaluator/logs/access.log \
    --error-logfile /root/bianjb/translation_evaluator/logs/error.log \
    eval_server:app

# é‡å¯ç­–ç•¥
Restart=always
RestartSec=10

# èµ„æºé™åˆ¶ï¼ˆå¯é€‰ï¼‰
MemoryMax=8G
CPUQuota=200%

# æ—¥å¿—é…ç½®
StandardOutput=journal
StandardError=journal
SyslogIdentifier=translation-evaluator

[Install]
WantedBy=multi-user.target
```

### ä½¿ç”¨æ­¥éª¤

```bash
# 1. é‡æ–°åŠ è½½systemdé…ç½®
sudo systemctl daemon-reload

# 2. å¯ç”¨æœåŠ¡ï¼ˆå¼€æœºè‡ªå¯ï¼‰
sudo systemctl enable translation-evaluator

# 3. å¯åŠ¨æœåŠ¡
sudo systemctl start translation-evaluator

# 4. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status translation-evaluator

# 5. æŸ¥çœ‹å®æ—¶æ—¥å¿—
sudo journalctl -u translation-evaluator -f

# 6. åœæ­¢æœåŠ¡
sudo systemctl stop translation-evaluator

# 7. é‡å¯æœåŠ¡
sudo systemctl restart translation-evaluator

# 8. ç¦ç”¨å¼€æœºè‡ªå¯
sudo systemctl disable translation-evaluator
```

### å¿«é€Ÿé…ç½®è„šæœ¬

åˆ›å»º `setup_systemd_service.sh`ï¼š

```bash
#!/bin/bash

# é…ç½®å˜é‡ï¼ˆè¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰
PROJECT_DIR="/root/bianjb/translation_evaluator"
CONDA_ENV="/root/miniconda3/envs/tranlator_eval"
SERVICE_PORT="5001"
SERVICE_USER="root"

# åˆ›å»ºæœåŠ¡æ–‡ä»¶
sudo tee /etc/systemd/system/translation-evaluator.service > /dev/null <<EOF
[Unit]
Description=Translation Evaluator API Service
After=network.target

[Service]
Type=simple
User=$SERVICE_USER
Group=$SERVICE_USER
WorkingDirectory=$PROJECT_DIR
Environment="PATH=$CONDA_ENV/bin"
Environment="USE_REQUEST_QUEUE=true"
Environment="MAX_QUEUE_SIZE=50"
Environment="REQUEST_TIMEOUT=600"
Environment="USE_BLEURT=true"
Environment="BLEURT_USE_SUBPROCESS=true"
Environment="BLEURT_PYTHON_ENV=/root/miniconda3/envs/translator_eval_bleurt/bin/python"
Environment="BLEURT_WORKER_SCRIPT=$PROJECT_DIR/bleurt_worker.py"
Environment="BLEURT_CHECKPOINT=$PROJECT_DIR/BLEURT-20"
Environment="COMET_MODEL_PATH=/root/bianjb/wmt22-comet-da"
Environment="HF_HOME=/root/.cache/huggingface"
ExecStart=$CONDA_ENV/bin/gunicorn \
    -w 1 \
    --preload \
    -b 0.0.0.0:$SERVICE_PORT \
    --timeout 600 \
    --access-logfile $PROJECT_DIR/logs/access.log \
    --error-logfile $PROJECT_DIR/logs/error.log \
    eval_server:app
Restart=always
RestartSec=10
MemoryMax=8G
StandardOutput=journal
StandardError=journal
SyslogIdentifier=translation-evaluator

[Install]
WantedBy=multi-user.target
EOF

# é‡æ–°åŠ è½½systemd
sudo systemctl daemon-reload

# å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡
sudo systemctl enable translation-evaluator
sudo systemctl start translation-evaluator

# ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 3

# æ˜¾ç¤ºçŠ¶æ€
echo "=========================================="
echo "æœåŠ¡çŠ¶æ€:"
echo "=========================================="
sudo systemctl status translation-evaluator --no-pager -l

echo ""
echo "=========================================="
echo "å¸¸ç”¨å‘½ä»¤:"
echo "=========================================="
echo "å¯åŠ¨æœåŠ¡: sudo systemctl start translation-evaluator"
echo "åœæ­¢æœåŠ¡: sudo systemctl stop translation-evaluator"
echo "é‡å¯æœåŠ¡: sudo systemctl restart translation-evaluator"
echo "æŸ¥çœ‹çŠ¶æ€: sudo systemctl status translation-evaluator"
echo "æŸ¥çœ‹æ—¥å¿—: sudo journalctl -u translation-evaluator -f"
echo "æŸ¥çœ‹æœ€è¿‘æ—¥å¿—: sudo journalctl -u translation-evaluator -n 100"
```

ä½¿ç”¨ï¼š

```bash
chmod +x setup_systemd_service.sh
./setup_systemd_service.sh
```

---

## ğŸ”§ æ–¹æ¡ˆäºŒï¼šnohupï¼ˆç®€å•å¿«é€Ÿï¼‰

### é€‚ç”¨åœºæ™¯
- ä¸´æ—¶æµ‹è¯•
- ä¸éœ€è¦è‡ªåŠ¨é‡å¯
- æ²¡æœ‰rootæƒé™

### ä½¿ç”¨æ–¹æ³•

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /root/bianjb/translation_evaluator

# è®¾ç½®ç¯å¢ƒå˜é‡
export USE_REQUEST_QUEUE=true
export USE_BLEURT=true
export BLEURT_USE_SUBPROCESS=true
export BLEURT_PYTHON_ENV=/root/miniconda3/envs/translator_eval_bleurt/bin/python
export BLEURT_WORKER_SCRIPT=/root/bianjb/translation_evaluator/bleurt_worker.py
export BLEURT_CHECKPOINT=/root/bianjb/translation_evaluator/BLEURT-20
export COMET_MODEL_PATH=/root/bianjb/wmt22-comet-da

# ä½¿ç”¨nohupåå°è¿è¡Œ
nohup gunicorn -w 1 --preload -b 0.0.0.0:5001 --timeout 600 eval_server:app > logs/gunicorn.log 2>&1 &

# æŸ¥çœ‹è¿›ç¨‹ID
echo $!

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/gunicorn.log
```

### ç®¡ç†å‘½ä»¤

```bash
# æŸ¥æ‰¾è¿›ç¨‹
ps aux | grep gunicorn

# åœæ­¢æœåŠ¡ï¼ˆä½¿ç”¨è¿›ç¨‹IDï¼‰
kill <PID>

# æˆ–ä½¿ç”¨pkill
pkill -f "gunicorn.*eval_server"

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/gunicorn.log
```

### åˆ›å»ºå¯åŠ¨è„šæœ¬

åˆ›å»º `start_background.sh`ï¼š

```bash
#!/bin/bash

cd /root/bianjb/translation_evaluator

# è®¾ç½®ç¯å¢ƒå˜é‡
export USE_REQUEST_QUEUE=true
export USE_BLEURT=true
export BLEURT_USE_SUBPROCESS=true
export BLEURT_PYTHON_ENV=/root/miniconda3/envs/translator_eval_bleurt/bin/python
export BLEURT_WORKER_SCRIPT=/root/bianjb/translation_evaluator/bleurt_worker.py
export BLEURT_CHECKPOINT=/root/bianjb/translation_evaluator/BLEURT-20
export COMET_MODEL_PATH=/root/bianjb/wmt22-comet-da

# æ£€æŸ¥æ˜¯å¦å·²åœ¨è¿è¡Œ
if pgrep -f "gunicorn.*eval_server" > /dev/null; then
    echo "æœåŠ¡å·²åœ¨è¿è¡Œä¸­"
    ps aux | grep "gunicorn.*eval_server" | grep -v grep
    exit 1
fi

# å¯åŠ¨æœåŠ¡
echo "å¯åŠ¨æœåŠ¡..."
nohup gunicorn -w 1 --preload -b 0.0.0.0:5001 --timeout 600 eval_server:app > logs/gunicorn.log 2>&1 &

# ä¿å­˜è¿›ç¨‹ID
echo $! > logs/gunicorn.pid

echo "æœåŠ¡å·²å¯åŠ¨ï¼ŒPID: $(cat logs/gunicorn.pid)"
echo "æŸ¥çœ‹æ—¥å¿—: tail -f logs/gunicorn.log"
```

åˆ›å»º `stop_background.sh`ï¼š

```bash
#!/bin/bash

cd /root/bianjb/translation_evaluator

if [ -f logs/gunicorn.pid ]; then
    PID=$(cat logs/gunicorn.pid)
    if ps -p $PID > /dev/null 2>&1; then
        echo "åœæ­¢æœåŠ¡ (PID: $PID)..."
        kill $PID
        rm logs/gunicorn.pid
        echo "æœåŠ¡å·²åœæ­¢"
    else
        echo "è¿›ç¨‹ä¸å­˜åœ¨ï¼Œæ¸…ç†PIDæ–‡ä»¶"
        rm logs/gunicorn.pid
    fi
else
    echo "æœªæ‰¾åˆ°PIDæ–‡ä»¶ï¼Œå°è¯•æŸ¥æ‰¾è¿›ç¨‹..."
    pkill -f "gunicorn.*eval_server"
    echo "å·²å°è¯•åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹"
fi
```

ä½¿ç”¨ï¼š

```bash
chmod +x start_background.sh stop_background.sh
./start_background.sh    # å¯åŠ¨
./stop_background.sh     # åœæ­¢
```

---

## ğŸ–¥ï¸ æ–¹æ¡ˆä¸‰ï¼šscreenï¼ˆå¯äº¤äº’ï¼‰

### é€‚ç”¨åœºæ™¯
- éœ€è¦æŸ¥çœ‹å®æ—¶è¾“å‡º
- å¼€å‘è°ƒè¯•
- ä¸´æ—¶ä½¿ç”¨

### ä½¿ç”¨æ–¹æ³•

```bash
# å®‰è£…screenï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
sudo apt-get install screen -y

# åˆ›å»ºæ–°çš„screenä¼šè¯
screen -S translation-evaluator

# åœ¨screenä¸­å¯åŠ¨æœåŠ¡
cd /root/bianjb/translation_evaluator
export USE_REQUEST_QUEUE=true
export USE_BLEURT=true
# ... å…¶ä»–ç¯å¢ƒå˜é‡
gunicorn -w 1 --preload -b 0.0.0.0:5001 --timeout 600 eval_server:app

# æŒ‰ Ctrl+A ç„¶åæŒ‰ D æ¥åˆ†ç¦»ä¼šè¯ï¼ˆæœåŠ¡ç»§ç»­è¿è¡Œï¼‰

# é‡æ–°è¿æ¥ä¼šè¯
screen -r translation-evaluator

# æŸ¥çœ‹æ‰€æœ‰ä¼šè¯
screen -ls

# æ€æ­»ä¼šè¯
screen -X -S translation-evaluator quit
```

---

## ğŸ–¥ï¸ æ–¹æ¡ˆå››ï¼štmuxï¼ˆå¯äº¤äº’ï¼‰

### é€‚ç”¨åœºæ™¯
- éœ€è¦æŸ¥çœ‹å®æ—¶è¾“å‡º
- å¼€å‘è°ƒè¯•
- ä¸´æ—¶ä½¿ç”¨

### ä½¿ç”¨æ–¹æ³•

```bash
# å®‰è£…tmuxï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
sudo apt-get install tmux -y

# åˆ›å»ºæ–°çš„tmuxä¼šè¯
tmux new -s translation-evaluator

# åœ¨tmuxä¸­å¯åŠ¨æœåŠ¡
cd /root/bianjb/translation_evaluator
export USE_REQUEST_QUEUE=true
export USE_BLEURT=true
# ... å…¶ä»–ç¯å¢ƒå˜é‡
gunicorn -w 1 --preload -b 0.0.0.0:5001 --timeout 600 eval_server:app

# æŒ‰ Ctrl+B ç„¶åæŒ‰ D æ¥åˆ†ç¦»ä¼šè¯ï¼ˆæœåŠ¡ç»§ç»­è¿è¡Œï¼‰

# é‡æ–°è¿æ¥ä¼šè¯
tmux attach -t translation-evaluator

# æŸ¥çœ‹æ‰€æœ‰ä¼šè¯
tmux ls

# æ€æ­»ä¼šè¯
tmux kill-session -t translation-evaluator
```

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“

### ç”Ÿäº§ç¯å¢ƒæ¨èï¼šsystemd

**ä¼˜ç‚¹**ï¼š
- âœ… ç³»ç»Ÿçº§ç®¡ç†ï¼Œç¨³å®šå¯é 
- âœ… è‡ªåŠ¨å¯åŠ¨å’Œé‡å¯
- âœ… æ—¥å¿—ç»Ÿä¸€ç®¡ç†
- âœ… èµ„æºé™åˆ¶é…ç½®

**é…ç½®æ­¥éª¤**ï¼š
1. åˆ›å»º `/etc/systemd/system/translation-evaluator.service`
2. è¿è¡Œ `sudo systemctl daemon-reload`
3. è¿è¡Œ `sudo systemctl enable translation-evaluator`
4. è¿è¡Œ `sudo systemctl start translation-evaluator`

### ä¸´æ—¶ä½¿ç”¨æ¨èï¼šnohup

**ä¼˜ç‚¹**ï¼š
- âœ… ç®€å•å¿«é€Ÿ
- âœ… æ— éœ€rootæƒé™

**é…ç½®æ­¥éª¤**ï¼š
1. è®¾ç½®ç¯å¢ƒå˜é‡
2. è¿è¡Œ `nohup gunicorn ... &`

### å¼€å‘è°ƒè¯•æ¨èï¼šscreen/tmux

**ä¼˜ç‚¹**ï¼š
- âœ… å¯æŸ¥çœ‹å®æ—¶è¾“å‡º
- âœ… å¯äº¤äº’æ“ä½œ

---

## ğŸ” éªŒè¯æœåŠ¡è¿è¡Œ

### æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# systemdæ–¹å¼
sudo systemctl status translation-evaluator

# nohupæ–¹å¼
ps aux | grep gunicorn

# æ£€æŸ¥ç«¯å£
netstat -tlnp | grep 5001
# æˆ–
ss -tlnp | grep 5001
```

### æµ‹è¯•API

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:5001/health

# é˜Ÿåˆ—ç»Ÿè®¡
curl http://localhost:5001/queue/stats
```

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: æœåŠ¡å¯åŠ¨å¤±è´¥

**æ£€æŸ¥æ—¥å¿—**ï¼š
```bash
# systemd
sudo journalctl -u translation-evaluator -n 50

# nohup
tail -n 50 logs/gunicorn.log
```

**å¸¸è§åŸå› **ï¼š
- è·¯å¾„é”™è¯¯
- ç¯å¢ƒå˜é‡æœªè®¾ç½®
- ç«¯å£è¢«å ç”¨
- æƒé™é—®é¢˜

### Q2: æœåŠ¡è‡ªåŠ¨åœæ­¢

**systemdè‡ªåŠ¨é‡å¯**ï¼š
- æ£€æŸ¥ `Restart=always` é…ç½®
- æŸ¥çœ‹æ—¥å¿—æ‰¾å‡ºå´©æºƒåŸå› 

**nohupæ–¹å¼**ï¼š
- éœ€è¦æ‰‹åŠ¨é‡å¯
- å»ºè®®æ”¹ç”¨systemd

### Q3: å¦‚ä½•æ›´æ–°ä»£ç 

```bash
# åœæ­¢æœåŠ¡
sudo systemctl stop translation-evaluator

# æ›´æ–°ä»£ç 
cd /root/bianjb/translation_evaluator
git pull

# é‡å¯æœåŠ¡
sudo systemctl start translation-evaluator
```

### Q4: å¦‚ä½•æŸ¥çœ‹å®æ—¶æ—¥å¿—

```bash
# systemd
sudo journalctl -u translation-evaluator -f

# nohup
tail -f logs/gunicorn.log

# åŒæ—¶æŸ¥çœ‹accesså’Œerroræ—¥å¿—
tail -f logs/access.log logs/error.log
```

---

## ğŸ¯ æ¨èé…ç½®

**ç”Ÿäº§ç¯å¢ƒ**ï¼š
```bash
# ä½¿ç”¨systemd + å•worker + é¢„åŠ è½½
gunicorn -w 1 --preload -b 0.0.0.0:5001 --timeout 600 eval_server:app
```

**å¼€å‘ç¯å¢ƒ**ï¼š
```bash
# ä½¿ç”¨nohupæˆ–ç›´æ¥è¿è¡Œ
python eval_server.py
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Ubuntuéƒ¨ç½²æ–¹æ¡ˆè¯„ä¼°.md](./Ubuntuéƒ¨ç½²æ–¹æ¡ˆè¯„ä¼°.md)
- [è¯·æ±‚é˜Ÿåˆ—ä½¿ç”¨æŒ‡å—.md](./è¯·æ±‚é˜Ÿåˆ—ä½¿ç”¨æŒ‡å—.md)
- [é£é™©è¯„ä¼°ä¸åº”å¯¹æªæ–½.md](./é£é™©è¯„ä¼°ä¸åº”å¯¹æªæ–½.md)
